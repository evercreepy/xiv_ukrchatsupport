name: Create Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+.[0-9]+'   # e.g. 1.0.0.36

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore G4EUkrChatSupportFork/G4EUkrChatSupportFork.csproj

      - name: Download Dalamud (dev hooks)
        run: |
          $dest = "$env:APPDATA\XIVLauncher\addon\Hooks\dev"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          Invoke-WebRequest -Uri "https://goatcorp.github.io/dalamud-distrib/stg/latest.zip" -OutFile "dalamud.zip" -UseBasicParsing
          Expand-Archive -Force "dalamud.zip" $dest

      - name: Build
        run: |
          $ver = "${{ github.ref_name }}"
          dotnet build G4EUkrChatSupportFork/G4EUkrChatSupportFork.csproj `
            --no-restore `
            --configuration Release `
            --nologo `
            -p:Version=$ver `
            -p:AssemblyVersion=$ver `
            -p:FileVersion=$ver

      - name: Prepare release asset
        run: |
          $src = "G4EUkrChatSupportFork/bin/Release/G4EUkrChatSupportFork/latest.zip"
          if (-not (Test-Path $src)) { throw "Build output not found: $src" }
          Copy-Item $src "G4EUkrChatSupport.zip"

      - name: Create Release
        run: |
          gh release create "${{ github.ref_name }}" G4EUkrChatSupport.zip `
            --title "G4E UkrChatSupport (Fork) ${{ github.ref_name }}" `
            --notes "Plugin release ${{ github.ref_name }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
